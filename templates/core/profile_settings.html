{% extends "core/profile.html" %}
{% load widget_tweaks %}

{% block profile_content %}
<div id="settings" class="">

    <div class="py-3 flex flex-col">
        <div class="flex flex-col items-center justify-center">
            <span class="text-xl">Background</span>
            
            <div class="join flex justify-center py-4" _="init call themeController()">
                <input type="radio" name="theme-dropdown" class="btn theme-controller join-item" aria-label="Dark" hx-post="{% url "change_theme" %}" value="dark"/>
                <input type="radio" name="theme-dropdown" class="btn theme-controller join-item" aria-label="Light" hx-post="{% url "change_theme" %}" value="light"/>
                <input type="radio" name="theme-dropdown" class="btn theme-controller join-item" aria-label="Nord" hx-post="{% url "change_theme" %}" value="nord"/>
                <input type="radio" name="theme-dropdown" class="btn theme-controller join-item" aria-label="Sunset" hx-post="{% url "change_theme" %}" value="sunset"/>
                <input type="radio" name="theme-dropdown" class="btn theme-controller join-item" aria-label="Retro" hx-post="{% url "change_theme" %}" value="retro"/>
            </div>
        </div>

        <div class="divider"></div>
        <div class="w-[75%] m-auto flex flex-col items-center">
            <span class="text-xl">Edit profile info</span>
            <form 
            enctype="multipart/form-data"
            method="POST"
            action="{% url "profile_settings" username=request.user.username %}"
            class="flex flex-col"
            id="edit-form"
            >
                {% csrf_token %}
                <div class="pt-3">
                    <label for="dn" class="label">Display name</label>
                    {% render_field form.display_name class="input input-bordered focus:outline-none w-full" id="dn" placeholder="Display name" %}
                </div>
                <div class="pt-3">
                    <label for="bio" class="label">Bio</label>
                    {% render_field form.bio class="textarea textarea-bordered focus:outline-none h-40 resize-none w-full" id="bio" placeholder="Bio" %}
                </div>
                <div class="hidden">
                    {% render_field form.profile_picture id="id_media" %}
                </div>
                <div class="pt-3">
                    <label 
                        for="id_media" 
                        id="setUpPreview" 
                        class="custom-file-upload bx-tool rounded-full p-1 flex"
                        _="on click call setUpImagePreview()"
                    >
                        <i class='bx bx-image-alt m-auto'></i>
                    </label>
                    <div id="image-preview" _="on load call clearPreviewContainer()"></div>
                </div>
                <button type="submit" class="btn btn-info btn-sm rounded-full text-info-content w-[25%] mt-3">Save</button>
            </form>
        </div>
    </div>

    <script>
        function themeController() {
            const themeRadios = document.querySelectorAll('input[name="theme-dropdown"]');
          
            themeRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    const selectedTheme = this.value;
                    document.body.setAttribute('data-theme', selectedTheme);              
                });
            });
        }
    
        if (typeof isImagePreviewSetup === "undefined") {
            let isImagePreviewSetup = false;
    
            function setUpImagePreview() {
                console.log("set up image preview");
    
                if (isImagePreviewSetup) {
                    return;
                }
    
                document
                    .getElementById("id_media")
                    .addEventListener("change", function (event) {
                        console.log("preview");
                        const previewContainer =
                            document.getElementById("image-preview");
                        const fileMedia = document.getElementById("id_media");
                        const fileInput = event.target;
                        const files = fileInput.files;
    
                        previewContainer.innerHTML = "";
    
                        if (!files[0].type.startsWith("image/")) {
                            if (files.length === 0) return;
    
                            previewContainer.innerHTML = `<p class='text-red-500'><i class="bx bx-block text-red-500"></i> ${
                                files[0].name.split(".")[files[0].name.split(".").length - 1]
                            } extension is not allowed</p>`;
                            fileMedia.value = "";
    
                            setTimeout(function () {
                                const errorMessage = previewContainer.firstChild;
    
                                if (errorMessage) {
                                    errorMessage.style.transition = "opacity 0.5s";
                                    errorMessage.style.opacity = "0";
    
                                    setTimeout(function () {
                                        previewContainer.innerHTML = "";
                                    }, 500);
                                }
                            }, 3000);
                            return;
                        }
    
                        const reader = new FileReader();
    
                        reader.onload = function (e) {
                            const closeContainer = document.createElement("div");
                            closeContainer.classList.add(
                                "rounded-full",
                                "size-6",
                                "bg-base-300/75",
                                "absolute",
                                "top-1.5",
                                "right-1.5",
                                "cursor-pointer",
                            );
                            const imgElement = document.createElement("img");
                            imgElement.src = e.target.result;
    
                            const closeBtnElement = document.createElement("i");
                            closeBtnElement.classList.add(
                                "bx",
                                "bx-x",
                                "p-1",
                                "bg-transparent",
                                "rounded-full",
                                "hover:bg-base-300/95",
                            );
                            closeBtnElement.id = "image-preview-close";
    
                            closeContainer.appendChild(closeBtnElement);
                            previewContainer.appendChild(closeContainer);
                            previewContainer.appendChild(imgElement);
    
                            document
                                .getElementById("image-preview-close")
                                .addEventListener("click", function () {
                                    console.log("close");
                                    clearPreviewContainer();
                                });
                        };
    
                        reader.readAsDataURL(files[0]);
                    });
                isImagePreviewSetup = true;
            }
        }
    </script>
</div>
{% endblock profile_content %}